<!doctype html><html lang=en data-bs-theme=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preload href=https://ahoi-attacks.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://ahoi-attacks.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=https://ahoi-attacks.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 as=font type=font/woff2 crossorigin><script src=/js/color-mode.86a91f050a481d0a3f0c72ac26543cb6228c770875981c58dcbc008fd3f875c8.js integrity="sha256-hqkfBQpIHQo/DHKsJlQ8tiKMdwh1mBxY3LwAj9P4dcg="></script><link rel=stylesheet href=/main.fb4a9200e775a698fccfff90d148386c5368b8917c9e8d6543d02306db453fac3887029ff097bd30009649093e4d60e7399b4cae87928b1d2f9a11f9877107c3.css integrity="sha512-+0qSAOd1ppj8z/+Q0Ug4bFNouJF8no1lQ9AjBttFP6w4hwKf8Je9MACWSQk+TWDnOZtMroeSix0vmhH5h3EHww==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><base href=https://ahoi-attacks.github.io/wesee/><link rel=canonical href=https://ahoi-attacks.github.io/wesee/><title>WeSee</title>
<meta name=description content="Using Malicious #VC Interrupts to Break AMD SEV-SNP"><link rel=icon href=/favicon.ico sizes=32x32><link rel=icon href=/favicon.svg type=image/svg+xml><link rel=apple-touch-icon href=/apple-touch-icon.png sizes=180x180 type=image/png><link rel=icon href=/favicon-192x192.png sizes=192x192 type=image/png><link rel=icon href=/favicon-512x512.png sizes=512x512 type=image/png><link rel=manifest href=/manifest.webmanifest><meta property="og:title" content="WeSee"><meta property="og:description" content="Using Malicious #VC Interrupts to Break AMD SEV-SNP"><meta property="og:type" content="article"><meta property="og:url" content="https://ahoi-attacks.github.io/wesee/"><meta property="og:image" content="https://ahoi-attacks.github.io/preview.png?123456"><meta property="article:section" content><meta property="article:published_time" content="2024-04-04T00:04:48+02:00"><meta property="article:modified_time" content="2024-04-04T00:04:48+02:00"><meta property="og:site_name" content="Ahoi Attacks"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ahoi-attacks.github.io/preview.png?123456"><meta name=twitter:title content="WeSee"><meta name=twitter:description content="Using Malicious #VC Interrupts to Break AMD SEV-SNP"><meta name=twitter:site content="@sectrs_ethz"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://ahoi-attacks.github.io/","name":"Ahoi Attacks","position":1},{"@type":"ListItem","name":"We See","position":2}]}</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-N42SFQ45B4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N42SFQ45B4")</script><script>console.log("<!-- Hacked together with <3 in emacs --->")</script></head><body class="single wesee" data-bs-spy=scroll data-bs-target=#toc data-bs-root-margin="0px 0px -60%" data-bs-smooth-scroll=true tabindex=0><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg"><div class=container-lg><a class="navbar-brand me-auto me-lg-3" href=/>Ahoi Attacks</a>
<button type=button id=searchToggleMobile class="btn btn-link nav-link mx-2 d-lg-none" aria-label="Search website">
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button class="btn btn-link nav-link mx-2 order-3 d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasNavMain aria-controls=offcanvasNavMain aria-label="Open main navigation menu"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><div class="offcanvas offcanvas-end h-auto" tabindex=-1 id=offcanvasNavMain aria-labelledby=offcanvasNavMainLabel><div class="header-bar d-lg-none"></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasNavMainLabel>Ahoi Attacks</h5><button type=button class="btn btn-link nav-link p-0 ms-auto" data-bs-dismiss=offcanvas aria-label=Close><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg></button></div><div class="offcanvas-body d-flex flex-column flex-lg-row justify-content-between"><ul class="navbar-nav flex-grow-1"><li class=nav-item><a class=nav-link href=https://ahoi-attacks.github.io/heckler/>Heckler</a></li><li class=nav-item><a class="nav-link active" href=https://ahoi-attacks.github.io/wesee aria-current=true>WeSee</a></li><li class=nav-item><a class=nav-link href=https://ahoi-attacks.github.io/sigy>Sigy</a></li><li class=nav-item><a class=nav-link href=https://ahoi-attacks.github.io/blog/>Blog</a></li><li class=nav-item><a class=nav-link href=https://ahoi-attacks.github.io/media/>Media</a></li></ul><button type=button id=searchToggleDesktop class="btn btn-link nav-link p-2 d-none d-lg-block" aria-label="Search website">
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
</button>
<button id=buttonColorMode class="btn btn-link mx-auto nav-link p-0 ms-lg-2 me-lg-1" type=button aria-label="Toggle theme"><svg data-bs-theme-value="dark" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg><svg data-bs-theme-value="light" xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-4 0a4 4 0 108 0 4 4 0 10-8 0m-5 0h1m8-9v1m8 8h1m-9 8v1M5.6 5.6l.7.7m12.1-.7-.7.7m0 11.4.7.7m-12.1-.7-.7.7"/></svg></button><ul id=socialMenu class="nav mx-auto flex-row order-lg-4"><li class=nav-item><a class="nav-link social-link" href=https://twitter.com/sectrs_ethz><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-x" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4l11.733 16H20L8.267 4z"/><path d="M4 20l6.768-6.768m2.46-2.46L20 4"/></svg><small class="ms-2 visually-hidden">Twitter</small></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/ahoi-attacks><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><small class="ms-2 visually-hidden">GitHub</small></a></li></ul></div></div></div></header></div><div class=modal id=searchModal tabindex=-1 aria-labelledby=searchModalLabel aria-hidden=true><div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down"><div class=modal-content><div class=modal-header><h1 class="modal-title fs-5 visually-hidden" id=searchModalLabel>Search</h1><button type=button class="btn-close visually-hidden" data-bs-dismiss=modal aria-label=Close></button><div class="search-input flex-grow-1 d-none"><form id=search-form class=search-form action=# method=post accept-charset=UTF-8 role=search><label for=query class=visually-hidden>Search</label><div class=d-flex><input type=search id=query name=query class="search-text form-control form-control-lg" placeholder=Search aria-label=Search maxlength=128 autocomplete=off>
<button type=button class="btn btn-link text-decoration-none px-0 ms-3 d-md-none" data-bs-dismiss=modal aria-label=Close>Cancel</button></div></form></div></div><div class=modal-body><p class="search-loading status message d-none mt-3 text-center">Loading search index…</p><p class="search-no-recent message d-none mt-3 text-center">No recent searches</p><p class="search-no-results message d-none mt-3 text-center">No results for "<strong><span class=query-no-results>Query here</span></strong>"</p><div id=searchResults class=search-results></div><template><article class="search-result list-view"><div class="card my-3"><div class=card-body><header><h2 class="h5 title title-submitted mb-0"><a class="stretched-link text-decoration-none text-reset" href=#>Title here</a></h2><div class="submitted d-none"><time class=created-date>Date here</time></div></header><div class=content>Summary here</div></div></div></article></template></div><div class=modal-footer><ul class="list-inline me-auto d-none d-md-block"><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd><span class=DocSearch-Label>to select</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd><kbd class=me-2><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd><span class=DocSearch-Label>to navigate</span></li><li class=list-inline-item><kbd class=me-2><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd><span class=DocSearch-Label>to close</span></li></ul><p class=d-md-none>Search by <a class=text-decoration-none href=https://github.com/nextapps-de/flexsearch>FlexSearch</a></p></div></div></div></div><div class="wrap container-lg" role=document><div class=content><div class="row flex-xl-nowrap"><nav class="docs-toc docs-toc-offset d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=toc><ul><li><a href=#how-does-it-work>How Does It Work?</a><ul><li><a href=#bypass-authentication-with-wesee>Bypass Authentication with WeSee</a></li></ul></li><li><a href=#wesee-primitives>WeSee Primitives</a><ul><li><a href=#skip-instructions>Skip Instructions</a></li><li><a href=#read-and-write-to-rax>Read and Write to <code>rax</code></a></li><li><a href=#read-kernel-memory>Read Kernel Memory</a></li><li><a href=#write-to-kernel-memory>Write to Kernel Memory</a></li><li><a href=#arbitrary-code-injection>Arbitrary Code Injection</a></li></ul></li><li><a href=#breaking-into-cvms-with-wesee>Breaking into CVMs with WeSee</a><ul><li><a href=#gain-a-root-shell>Gain a Root Shell</a></li></ul></li><li><a href=#affected-hardware-and-software>Affected Hardware and Software</a></li><li><a href=#faqs>FAQs</a></li><li><a href=#authors>Authors</a></li><li><a href=#responsible-disclosure>Responsible Disclosure</a></li><li><a href=#cve>CVE</a></li></ul></nav></div></nav><div class='docs-content col-lg-0 col-xl-2'></div><main class="docs-content col-lg-16 col-xl-9"><nav class="toc-mobile d-xl-none" aria-label="Quaternary navigation"><details><summary>On this page</summary><div class=page-links><nav id=TableOfContents><ul><li><a href=#how-does-it-work>How Does It Work?</a><ul><li><a href=#bypass-authentication-with-wesee>Bypass Authentication with WeSee</a></li></ul></li><li><a href=#wesee-primitives>WeSee Primitives</a><ul><li><a href=#skip-instructions>Skip Instructions</a></li><li><a href=#read-and-write-to-rax>Read and Write to <code>rax</code></a></li><li><a href=#read-kernel-memory>Read Kernel Memory</a></li><li><a href=#write-to-kernel-memory>Write to Kernel Memory</a></li><li><a href=#arbitrary-code-injection>Arbitrary Code Injection</a></li></ul></li><li><a href=#breaking-into-cvms-with-wesee>Breaking into CVMs with WeSee</a><ul><li><a href=#gain-a-root-shell>Gain a Root Shell</a></li></ul></li><li><a href=#affected-hardware-and-software>Affected Hardware and Software</a></li><li><a href=#faqs>FAQs</a></li><li><a href=#authors>Authors</a></li><li><a href=#responsible-disclosure>Responsible Disclosure</a></li><li><a href=#cve>CVE</a></li></ul></nav></div></details></nav><div class=text-center style=padding-bottom:3rem><div><img src=/WeSee-symbol.svg style=margin-top:3rem;margin-bottom:-1rem;width:400px></div><h1 class=h1>WeSee</h1><p class=lead>Using Malicious #VC Interrupts to Break AMD SEV-SNP<br>(Distinguished Paper Award, <a href=https://sp2024.ieee-security.org/>IEEE S&P 2024</a>)</p><div class="row justify-content-center"><div class="col-lg-5 col-sm-6 text-center go-button" style=margin-top:1.2rem><div class="d-flex flex-column flex-sm-row w-100 text-center"><a class="btn btn-primary btn-cta rounded-pill btn-lg head-button" href=/wesee/wesee_oakland24.pdf role=button>Paper</a></div></div><div class="col-lg-5 col-sm-6 go-button" style=margin-top:1.2rem><div class="d-flex flex-column flex-sm-row"><a class="btn btn-primary btn-cta rounded-pill btn-lg head-button" href=https://github.com/ahoi-attacks/WeSee role=button>Source</a></div></div><div class="col-lg-5 col-sm-6 go-button" style=margin-top:1.2rem><div class="d-flex flex-column flex-sm-row"><a class="btn btn-primary btn-cta rounded-pill btn-lg head-button" href=#cve role=button>CVE</a></div></div></div></div><h2 id=how-does-it-work>How Does It Work?<a href=#how-does-it-work class=anchor aria-hidden=true>#</a></h2><p>AMD SEV-SNP enables the creation of Confidential VMs (CVMs). This setting assumes a malicious hypervisor that cannot directly access the CVM’s memory. In a non-confidential setting, the hypervisor performs different operations (e.g., service hypercalls) that are important for the functionality of the applications. To support this functionality in the presence of a malicious hypervisor, AMD SEV introduces a new VMM Communication exception (#VC).</p><p><strong>#VC without an attacker:</strong>
Let’s first look at how #VC is handled during a benign execution. The trusted hardware raises #VC when the CVM executes certain operations (e.g., <a href=https://www.felixcloutier.com/x86/vmcall><code>vmmcall</code></a>) as shown in the Animation below. The trusted hardware also stores the information about the operation that caused the #VC in the <code>exit_reason</code> register. The trusted guest Linux kernel in the CVM registers a handler for #VC. This handler reads the <code>exit_reason</code> and copies the necessary memory and register values into an unprotected shared memory region called the Guest Hypervisor Communication Block (GHCB) as shown in the Animation above. Then, the handler transfers the execution to the hypervisor. Once the hypervisor returns, the #VC handler copies data and register values back to the application context.</p><p><img src=/wesee/wesee-benign.webp width=960 height=540 decoding=async fetchpriority=auto loading=lazy alt=wesee-benign id=h-rh-i-0></p><p>WeSee abuses the #VC handler in the kernel to compromise the CVM with 2 main observations: (a) the hypervisor can arbitrarily raise #VC to the CVM by injecting interrupt number 29 and (b) the hypervisor can control the value in the <code>exit_reason</code> register. We illustrate the hypervisor capabilities to compromise the security of the CVM with the example below.</p><h3 id=bypass-authentication-with-wesee>Bypass Authentication with WeSee<a href=#bypass-authentication-with-wesee class=anchor aria-hidden=true>#</a></h3><p>Let&rsquo;s consider an application that writes an application key <code>key_app</code> into <code>rax</code> and then uses the value in <code>rax</code> to authenticate a user who enters an input key (<code>k_in</code>).</p><div class=expressive-code><figure class="frame not-content"><figcaption class=header><span class=title></span></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rax</span> <span class=o>=</span> <span class=n>key_app</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>rax</span> <span class=o>==</span> <span class=n>k_in</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=n>auth</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>   <span class=n>fail</span></span></span></code></pre></div></figure></div><p>A malicious hypervisor without the right key can use WeSee to trick the victim application and authenticate successfully. Specifically, in the Code above, the hypervisor uses WeSee to change <code>rax</code> to a key that it controls (<code>key_hyp</code>). Then the application would inadvertently compare <code>k_in</code> with <code>k_hyp</code> to check if a user is authenticated. Because the hypervisor now controls both <code>k_in</code> and <code>k_hyp</code> it can authenticate successfully.
<img src=/wesee/wesee-example.webp width=960 height=540 decoding=async fetchpriority=auto loading=lazy alt=wesee-example id=h-rh-i-1></p><p>In the Animation above, the hypervisor injects #VC with <code>vmmcall</code> as the <code>exit_reason</code>. This causes the #VC handler to first leak the value in the application’s <code>rax</code> (i.e., <code>key_app</code>) and then to write a hypervisor-controlled value into the application’s <code>rax</code> (i.e., <code>key_hyp</code>). Therefore, when the control returns back to the application, the value in <code>rax</code> is changed to <code>key_hyp</code> and the hypervisor authentication successfully.</p><h2 id=wesee-primitives>WeSee Primitives<a href=#wesee-primitives class=anchor aria-hidden=true>#</a></h2><p>The hypervisor can set <code>exit_reason</code> register to any value of the 16 possible options. In WeSee we only use three: <code>vmmcall</code>, <code>mmio_read</code>, and <code>mmio_write</code>, and they are sufficient to construct powerful primitives.</p><h3 id=skip-instructions>Skip Instructions<a href=#skip-instructions class=anchor aria-hidden=true>#</a></h3><p>First, we construct a primitive to skip arbitrary instructions while the kernel executes. We observe that the #VC handler increments the instruction pointer <code>rip</code> once the #VC is successfully handled. Therefore, by chaining #VCs we can skip any number of instructions. We ensure that the #VC execution does not have any undesirable side effects (e.g., change in register values). Therefore, we use <code>exit_reason = vmmcall</code> which does not have any undesirable side effects—it only reads <code>rax</code> and writes a hypervisor-controlled value to <code>rax</code>.</p><h3 id=read-and-write-to-rax>Read and Write to <code>rax</code><a href=#read-and-write-to-rax class=anchor aria-hidden=true>#</a></h3><p>Next, we build primitives to read and write to <code>rax</code> using <code>exit_reason=vmmcall</code>. As shown in our example attack, on <code>vmmcall</code> the #VC handler leaks the value of <code>rax</code> to the hypervisor. Then, it writes a hypervisor-controlled value into <code>rax</code> when the control returns. Furthermore, this does not have any other undesirable side effects. Therefore, we use the hypervisor to inject #VC with <code>exit_reason=vmmcall</code> to build our primitives.</p><h3 id=read-kernel-memory>Read Kernel Memory<a href=#read-kernel-memory class=anchor aria-hidden=true>#</a></h3><p>To successfully read any kernel memory of the hypervisor’s choosing, the hypervisor needs 2 capabilities: (a) be able to control a pointer to kernel memory, and (b) this pointer is dereferenced and copied to the GHCB.</p><p><em>#VC handling for MMIO write:</em> We observe that the hypervisor can gain these capabilities by abusing the <code>mmio_write</code> case in the #VC handler. Specifically, on a legitimate MMIO write from the application (e.g., <code>mov [rdi], rbx</code>), the hypervisor needs the value stored in the application’s context to write into the MMIO region (e.g., value in <code>rbx</code>). Therefore, the #VC handler first invokes a function <code>get_ptr</code> to get a pointer to the application’s register as shown in the Animation below. Note that, <code>get_ptr</code> returns the pointer in the <code>rax</code> register. Then, the #VC handler dereferences the value in the rax register and copies it into the GHCB. Thus, during normal operation, The hypervisor can use the value in the GHCB to write to the MMIO region.
<img src=/wesee/wesee-mmio_read.webp width=960 height=281 decoding=async fetchpriority=auto loading=lazy alt=wesee-mmio_read id=h-rh-i-2></p><p>Next, we look at how the hypervisor controls the address for the memory read.</p><p><em>Attack using MMIO write handling:</em> The hypervisor starts with the #VC exception with <code>exit_reason=mmio_write</code> as shown in the Animation below. Then, to gain control of the pointer, the hypervisor uses the read <code>rax</code> primitive when the <code>get_ptr</code> function returns. At this point, the hypervisor can write any address into the <code>rax</code> register. The #VC handler dereferences the <code>rax</code> as a pointer and writes the value into the GHCB leaking kernel memory values. For this attack to succeed, it is crucial for the hypervisor to eliminate undesirable side-effects (e.g., checks that lead to <code>fail</code> blocks). For a complete explanation check out our <a href=https://ahoi-attacks.github.io/wesee/wesee_oakland24.pdf>paper</a>.
<img src=/wesee/wesee-read_mem.webp width=960 height=540 decoding=async fetchpriority=auto loading=lazy alt=wesee-mem_read id=h-rh-i-3></p><h3 id=write-to-kernel-memory>Write to Kernel Memory<a href=#write-to-kernel-memory class=anchor aria-hidden=true>#</a></h3><p>Like the read memory primitive, the hypervisor can use <code>exit_reason=mmio_read</code> which reads a value from GHCB and writes it into the application’s context to arbitrarily write to kernel memory. We show the sequence of #VC injections and its effects in the Animation below.</p><p><img src=/wesee/wesee-write_mem.webp width=960 height=540 decoding=async fetchpriority=auto loading=lazy alt=wesee-mem_write id=h-rh-i-4></p><h3 id=arbitrary-code-injection>Arbitrary Code Injection<a href=#arbitrary-code-injection class=anchor aria-hidden=true>#</a></h3><p>To inject code to be executed in the kernel, we need to write to the <code>.text</code> section. By default, the kernel sets up its page tables such that the <code>.text</code> section is executable but not writable. To get around this constraint, we first use our read and write memory primitives to change the permissions in the kernel page tables. Specifically, we locate the page tables in kernel memory and then use the read memory primitive to perform a page table walk and the write memory primitive to edit the page permissions. Once all the permissions are changed, our target page is writable.
Finally, we can write shell code using a chain of write memory primitives to the target page.</p><h2 id=breaking-into-cvms-with-wesee>Breaking into CVMs with WeSee<a href=#breaking-into-cvms-with-wesee class=anchor aria-hidden=true>#</a></h2><p>We demonstrate the expressive power of WeSee with three end-to-end case studies.
We leak kernel TLS session keys for NGINX with the arbitrary read. We use arbitrary write and code injection primitives to disable firewall rules and open a root shell. Next, we explain how we gain the root shell.</p><h3 id=gain-a-root-shell>Gain a Root Shell<a href=#gain-a-root-shell class=anchor aria-hidden=true>#</a></h3><p>We demonstrate WeSee by injecting and executing arbitrary code in the guest Linux kernel.
The kernel exposes an API for kernel modules called <code>call_usermodehelper</code>. This API allows kernel modules to start a user space application from the kernel context. When invoked by a kernel module with an executable as an argument, it starts a process with the executable. Note that, this new process is started with root privileges. To attack a victim VM and gain a root shell, we can execute <code>call_usermodehelper</code> with</p><p><code>/bin/bash -c rm /tmp/t; mknod /tmp/t p; /bin/sh 0&lt;/tmp/t \| nc -ln 8001 1>/tmp/t</code></p><p>This command spawns a root shell that takes as input all network data from port 8001.</p><p>We inject our shell code into the Linux kernel’s function that receives and handles ICMP packets (<code>icmp_rcv</code>). To trigger this function, we send an ICMP packet to the SEV VM. When the shell code calls the <code>call_usermodehelper</code> API, it creates a new process with root privileges that provides a root shell that listens on port 8001. Then, to interact with the spawned shell we connect to the VM from the hypervisor using <code>netcat</code>. We inject a total of 2891 #VCs to perform the page walk and inject 392 bytes of shell code. See the video below for a demo!</p><iframe width=100% height=515 src="https://www.youtube-nocookie.com/embed/d5kdH-trg9o?si=cjyTu2Za81VnNmQ8rel=0" style=margin-top:2rem;margin-bottom:2rem title="YouTube video player" frameborder=0 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy=strict-origin-when-cross-origin allowfullscreen></iframe><p>In summary, a malicious hypervisor can use WeSee to compromise SEV-SNP VMs and gain root access. For more details on our attacks check out our <a href=/wesee/wesee_oakland24.pdf>paper</a> and <a href=https://github.com/ahoi-attacks/WeSee>code</a>.</p><h2 id=affected-hardware-and-software>Affected Hardware and Software<a href=#affected-hardware-and-software class=anchor aria-hidden=true>#</a></h2><p>All SEV-SNP processors are vulnerable to WeSee. There is a hotfix in the Linux kernel that mitigates our case study attacks. See FAQs for more information.</p><h2 id=faqs>FAQs<a href=#faqs class=anchor aria-hidden=true>#</a></h2><details><summary>Q: Does WeSee affect non-confidential VMs that I have in the cloud?</summary><ul><li>No. WeSee assumes a malicious hypervisor to inject interrupts. For on-confidential cloud VMs, the hypervisor is implicitly trusted and will not attack the VMs. The hypervisor also prevents other malicious co-tenant VMs from injecting interrupts into the victim VM by checking and filtering interrupt injections.</li></ul></details><details><summary>Q: How do I protect myself from WeSee?</summary><ul><li>WeSee is tracked under one <a href=#cve>CVE</a>: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25742">CVE-2024-25742</a></li><li>Upgrade the <a href=https://lore.kernel.org/lkml/20240311151909.GAZe8g7SqDKRcP4XrO@fat_crate.local/>Linux kernel</a> and use <a href=https://www.amd.com/content/dam/amd/en/documents/epyc-business-docs/solution-briefs/amd-secure-encrypted-virtualization-solution-brief.pdf>hardware features</a>.</li><li>Unfortunately, as of 4th April 2024, there is no software support to use this hardware feature in neither mainline Linux nor AMD prototype.</li></ul></details><details><summary>Q: Is this a side-channel attack?</summary><ul><li>No. WeSee is not a side-channel attack.</li></ul></details><details><summary>Q: What about other interrupt vectors?</summary><ul><li>In Heckler, we focused on using interrupt vectors with handlers that had
global effects. Please see our <a href=/heckler/heckler_usenix24.pdf>paper</a> for a
detailed analysis of the other interrupt vectors.</li></ul></details><details><summary>Q: How is this an Ahoi attack?</summary><ul><li>WeSee uses interrupts, a notification mechanism, to compromise AMD SEV-SNP VMs making it an Ahoi attack.</li></ul></details><details><summary>Q: Why the name WeSee?</summary><ul><li>WeSee is a word-play on the VC exception.</li></ul></details><details><summary>Q: What was the response from hardware manufacturers?</summary><ul><li>AMD acknowledged the attacks but concluded that this is a vulnerability in the third-party software implementations of SEV-SNP. You find more information in their <a href=https://www.amd.com/en/resources/product-security/bulletin/amd-sb-3008.html>security advisory</a>.</li></ul></details><details><summary>Q: What was the response from cloud vendors?</summary><ul><li><p>Azure thanked us for the disclosure and communicated that both Azure Confidential Computing and Azure confidential VMs are not vulnerable because they use restricted and alternate injection modes supported by AMD SEV-SNP.</p></li><li><p>AWS thanked us for the disclosure and communicated the following:</p><ul><li>AWS is aware of <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25742">CVE-2024-25742</a>, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25743">CVE-2024-25743</a>, and <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25744">CVE-2024-25744</a>, which
describes issues related to AMD Secure Encrypted Virtualization-Secure Nested
Paging (SEV-SNP). These CVEs describe paths through which an untrusted
hypervisor can inject interrupts into a virtualized guest running in an
SEV-SNP environment to obtain data from the guest that it should not be able
to read. Amazon EC2 does not rely on AMD SEV-SNP, Intel TDX, or similar
affected technologies, to provide confidentiality and integrity protections to
customers. The built-in hardware and associated firmware for confidentiality
protections of the EC2 Nitro Systems are offered to all customers by default;
these components are not affected by these issues. To support customers
running Amazon Linux as virtualized guests using AMD SEV-SNP, we are working
to release a kernel addressing the CVEs in the next release cycle.</li></ul></li><li><p>Google thanked us for the disclosure and is investigating it. At the
moment, they have neither confirmed nor denied the issue.</p></li></ul></details><h2 id=authors>Authors<a href=#authors class=anchor aria-hidden=true>#</a></h2><ul><li><a href=https://benschlueter.com/>Benedict Schlüter</a></li><li><a href=https://suprajas.com/>Supraja Sridhara</a></li><li><a href=https://abertschi.ch/>Andrin Bertschi</a></li><li><a href=https://shwetashinde.com>Shweta Shinde</a></li></ul><h2 id=responsible-disclosure>Responsible Disclosure<a href=#responsible-disclosure class=anchor aria-hidden=true>#</a></h2><p>We have responsibly disclosed our findings to AMD on 26 October 2023. At the request of AMD, we extended the embargo till 4 April 2024.</p><h2 id=cve>CVE<a href=#cve class=anchor aria-hidden=true>#</a></h2><p>WeSee is tracked under <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-25742">CVE-2024-25742</a>.</p><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"></div><div class="page-nav d-flex flex-column flex-sm-row"><div class="card w-100"><div class="card-body d-flex"><div class="d-flex flex-column justify-content-center"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M5 12l6 6"/><path d="M5 12l6-6"/></svg></div><div class="d-flex flex-column"><div class=text-body-secondary>Prev</div><a href=/heckler/ class="stretched-link text-reset text-decoration-none">Heckler</a></div></div></div><div class=m-2></div><div class="card text-end w-100"><div class="card-body d-flex justify-content-end"><div class="d-flex flex-column"><div class=text-body-secondary>Next</div><a href=/imprint/ class="stretched-link text-reset text-decoration-none">Imprint</a></div><div class="d-flex flex-column justify-content-center"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-arrow-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12h14"/><path d="M13 18l6-6"/><path d="M13 6l6 6"/></svg></div></div></div></div></main><div class='docs-content col-lg-0 col-xl-2'></div></div></div></div><footer class="footer text-muted"><div class=container-lg><div class=row><div class="col-lg-8 text-center text-lg-start"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=/imprint>Imprint</a></li></ul></div><div class="col-lg-8 text-center text-lg-end"><ul class=list-inline><li class=list-inline-item><a class=text-muted href=https://sectrs.ethz.ch/>Secure and Trustworthy Systems Group, ETH Zurich</a></li></ul></div></div></div></footer><script async src=/js/app.47b84f3b640408af6efe7bf4add1a36f5b9c6227fbae7b8bcdf0c9ce42fefc54.js integrity="sha256-R7hPO2QECK9u/nv0rdGjb1ucYif7rnuLzfDJzkL+/FQ="></script><script async src=/js/flexsearch.b6f80717bc68cd38b6ded7a061f96a73896db6be17a6582f09a63a6040040919.js integrity="sha256-tvgHF7xozTi23tegYflqc4lttr4XplgvCaY6YEAECRk="></script><script async src=/js/search-modal.4e30271fef6fac86c3b4143167e9784bd3f7037ce1045d03a321e7e799e91476.js integrity="sha256-TjAnH+9vrIbDtBQxZ+l4S9P3A3zhBF0DoyHn55npFHY="></script></body></html>